<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watchlist üé¨</title>

  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#ff8cd6;
      --bg2:#b084f7;
      --card: rgba(255,255,255,0.92);
      --ink:#141414;

      /* Who colors */
      --me:#ff2a2a;     /* red */
      --her:#ff4fc3;    /* pink */

      --muted:#6b7280;
      --border: rgba(20,20,20,0.12);
      --rounded: 22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      min-height:100vh;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,0.5), transparent 60%),
                  linear-gradient(135deg, var(--bg1), var(--bg2));
      padding: 24px;
    }

    .wrap{ max-width: 980px; margin: 0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title{
      font-family: "SF Pro Display", Inter, sans-serif;
      font-size: 34px;
      letter-spacing: -0.02em;
      margin:0;
    }

    .back{
      text-decoration:none;
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(255,255,255,0.45);
      padding: 10px 14px;
      border-radius: 999px;
      color: #111;
      font-weight: 600;
      backdrop-filter: blur(8px);
      transition: transform .15s ease;
    }
    .back:hover{ transform: translateY(-1px); }

    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.55);
      border-radius: var(--rounded);
      padding: 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.10);
      backdrop-filter: blur(10px);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.3fr 0.8fr 0.9fr 0.9fr;
      gap: 10px;
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: 1fr; }
    }

    label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      display:block;
      margin-bottom: 6px;
    }
    input, select, textarea{
      width:100%;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
      background: rgba(255,255,255,0.75);
    }
    textarea{ min-height: 44px; resize: vertical; }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
      align-items:center;
      justify-content: space-between;
    }

    .actions-left{ display:flex; gap:10px; flex-wrap:wrap; }
    .actions-right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    button{
      border:0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 700;
      cursor:pointer;
      transition: transform .12s ease;
    }
    button:hover{ transform: translateY(-1px); }
    button:disabled{
      opacity: 0.55;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-add{ background: #111; color: white; }
    .btn-clear{
      background: rgba(255,255,255,0.0);
      border: 1px solid var(--border);
      color: #111;
    }
    .btn-auth{
      background: rgba(255,255,255,0.0);
      border: 1px solid var(--border);
      color: #111;
      padding: 10px 12px;
    }

    .pill{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.6);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 13px;
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .pill input{
      border:0;
      padding:0;
      background:transparent;
      width: 190px;
      font-size: 13px;
      outline:none;
    }

    .status{
      font-size: 12px;
      color: rgba(20,20,20,0.6);
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,20,0.10);
      background: rgba(255,255,255,0.55);
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .list-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      margin: 16px 0 10px;
      flex-wrap: wrap;
    }

    .filters{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }

    #randomResult{
      margin: 10px 0 6px;
      font-weight: 800;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,0.6);
      border: 1px solid rgba(20,20,20,0.10);
      display:none;
    }

    ul{
      list-style:none;
      padding:0;
      margin:0;
      display:grid;
      gap: 10px;
    }

    .item{
      border: 1px solid rgba(20,20,20,0.10);
      border-radius: 18px;
      padding: 12px 12px;
      background: rgba(255,255,255,0.75);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }

    .meta{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }

    .name{
      font-weight: 800;
      font-size: 16px;
      line-height: 1.2;
      word-break: break-word;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .tag{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(20,20,20,0.10);
      background: rgba(255,255,255,0.65);
    }
    .notes{
      margin-top: 6px;
      font-size: 13px;
      color: #222;
      opacity: 0.9;
      white-space: pre-wrap;
    }

    .right{
      display:flex;
      gap: 8px;
      flex-shrink:0;
      align-items:center;
    }
    .small{
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.4);
      cursor:pointer;
      font-weight: 700;
    }

    /* Color by who */
    .by-me .name { color: var(--me); }
    .by-her .name { color: var(--her); }

    .watched .name{
      text-decoration: line-through;
      opacity: 0.6;
    }

    .empty{
      padding: 18px;
      border: 1px dashed rgba(20,20,20,0.20);
      border-radius: 18px;
      color: rgba(20,20,20,0.6);
      text-align:center;
      background: rgba(255,255,255,0.45);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h1 class="title">Watchlist üé¨</h1>
      <a class="back" href="index.html">‚Üê Back</a>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label for="title">Title</label>
          <input id="title" placeholder="e.g., Sh≈çgun / Interstellar / ATLA" />
        </div>

        <div>
          <label for="type">Type</label>
          <select id="type">
            <option value="Movie">Movie</option>
            <option value="Show">Show</option>
            <option value="Anime">Anime</option>
            <option value="Documentary">Documentary</option>
          </select>
        </div>

        <div>
          <label for="service">Streaming service</label>
          <select id="service">
            <option value="Netflix">Netflix</option>
            <option value="Hulu">Hulu</option>
            <option value="Max">Max</option>
            <option value="Disney+">Disney+</option>
            <option value="Prime Video">Prime Video</option>
            <option value="Apple TV+">Apple TV+</option>
            <option value="Peacock">Peacock</option>
            <option value="Paramount+">Paramount+</option>
            <option value="YouTube">YouTube</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div>
          <label for="who">Suggested by</label>
          <select id="who">
            <option value="me">Anzum (red)</option>
            <option value="her">Anika (pink)</option>
          </select>
        </div>

        <div style="grid-column: 1 / -1;">
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" placeholder="e.g., ‚ÄòAfter finals‚Äô, ‚ÄòSaturday night movie‚Äô, ‚ÄòEveryone says it‚Äôs amazing‚Äô"></textarea>
        </div>
      </div>

      <div class="actions">
        <div class="actions-left">
          <button type="button" class="btn-add" id="addBtn">Add to list</button>
          <button type="button" class="btn-clear" id="clearBtn" title="Deletes the whole list">Clear all</button>
          <button type="button" class="small" id="randomBtn" title="Picks from unwatched items that match current filters">üé≤ Random pick</button>
        </div>

        <div class="actions-right">
          <button type="button" class="btn-auth" id="loginBtn">Sign in</button>
          <button type="button" class="btn-auth" id="logoutBtn" style="display:none;">Sign out</button>
          <div id="syncStatus" class="status">Loading‚Ä¶</div>
        </div>
      </div>

      <div id="randomResult"></div>

      <div class="list-head">
        <div style="font-weight:800;">Your list</div>

        <div class="filters">
          <div class="pill">
            üîé <input id="search" placeholder="Search..." />
          </div>

          <select id="filterType" class="pill" style="padding:8px 10px;">
            <option value="All">All</option>
            <option value="Movie">Movies</option>
            <option value="Show">Shows</option>
            <option value="Anime">Anime</option>
            <option value="Documentary">Docs</option>
          </select>

          <select id="filterService" class="pill" style="padding:8px 10px;">
            <option value="All">All services</option>
            <option value="Netflix">Netflix</option>
            <option value="Hulu">Hulu</option>
            <option value="Max">Max</option>
            <option value="Disney+">Disney+</option>
            <option value="Prime Video">Prime Video</option>
            <option value="Apple TV+">Apple TV+</option>
            <option value="Peacock">Peacock</option>
            <option value="Paramount+">Paramount+</option>
            <option value="YouTube">YouTube</option>
            <option value="Other">Other</option>
          </select>

          <select id="filterWho" class="pill" style="padding:8px 10px;">
            <option value="All">Both</option>
            <option value="me">Me (red)</option>
            <option value="her">Anika (pink)</option>
          </select>
        </div>
      </div>

      <ul id="list"></ul>
      <div id="empty" class="empty" style="display:none;">
        Nothing here yet. Add your first movie/show üëÄ
      </div>
    </div>
  </div>

  <!-- Firebase (same style as your Bingo board): Google Login + Firestore realtime sync -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      serverTimestamp,
      doc,
      updateDoc,
      deleteDoc,
      getDocs,
      writeBatch
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    /**********************
     * FIREBASE CONFIG (from your Bingo board)
     **********************/
    const firebaseConfig = {
      apiKey: "AIzaSyCcbJqHpYRPFGgmgBh5grAhR5aDniDZRyg",
      authDomain: "tanzum-5c20b.firebaseapp.com",
      projectId: "tanzum-5c20b",
      storageBucket: "tanzum-5c20b.firebasestorage.app",
      messagingSenderId: "301887898670",
      appId: "1:301887898670:web:6b0d43c29148ea9b830bbf",
      measurementId: "G-FF64TZSZ2V"
    };

    // SAME room for both of you (change if you want)
    const ROOM_ID = "tanzum-watchlist";

    /**********************
     * INIT
     **********************/
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    /**********************
     * DOM
     **********************/
    const $ = (id) => document.getElementById(id);

    const titleEl = $("title");
    const typeEl = $("type");
    const serviceEl = $("service");
    const whoEl = $("who");
    const notesEl = $("notes");

    const addBtn = $("addBtn");
    const clearBtn = $("clearBtn");
    const randomBtn = $("randomBtn");

    const listEl = $("list");
    const emptyEl = $("empty");

    const searchEl = $("search");
    const filterTypeEl = $("filterType");
    const filterServiceEl = $("filterService");
    const filterWhoEl = $("filterWho");

    const randomResultEl = $("randomResult");
    const syncStatusEl = $("syncStatus");

    const loginBtn = $("loginBtn");
    const logoutBtn = $("logoutBtn");

    function setStatus(msg){ if(syncStatusEl) syncStatusEl.textContent = msg || ""; }

    /**********************
     * State
     **********************/
    let currentItems = [];
    let unsubscribe = null;
    let currentUser = null;

    /**********************
     * Helpers
     **********************/
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatDate(ts){
      const d = new Date(ts);
      return d.toLocaleString([], { month:"short", day:"numeric", year:"numeric" });
    }

    function showRandomResult(text){
      randomResultEl.style.display = "block";
      randomResultEl.textContent = text;
    }

    function setEnabled(enabled){
      addBtn.disabled = !enabled;
      clearBtn.disabled = !enabled;
      randomBtn.disabled = currentItems.filter(x => !x.watched).length === 0; // still usable after data loads
      titleEl.disabled = !enabled;
      typeEl.disabled = !enabled;
      serviceEl.disabled = !enabled;
      whoEl.disabled = !enabled;
      notesEl.disabled = !enabled;
    }

    function getFiltered(items){
      const q = searchEl.value.trim().toLowerCase();
      const ft = filterTypeEl.value;
      const fs = filterServiceEl.value;
      const fw = filterWhoEl.value;

      return items.filter(item => {
        const title = (item.title || "").toLowerCase();
        const notes = (item.notes || "").toLowerCase();
        const service = item.service || "Other";

        const matchesQ = !q || title.includes(q) || notes.includes(q);
        const matchesType = (ft === "All") || (item.type === ft);
        const matchesService = (fs === "All") || (service === fs);
        const matchesWho = (fw === "All") || (item.who === fw);

        return matchesQ && matchesType && matchesService && matchesWho;
      });
    }

    function render(){
      const filtered = getFiltered(currentItems);
      listEl.innerHTML = "";

      emptyEl.style.display = filtered.length === 0 ? "block" : "none";

      for(const item of filtered){
        const li = document.createElement("li");
        const whoClass = item.who === "me" ? "by-me" : "by-her";
        const watchedClass = item.watched ? "watched" : "";
        li.className = `item ${whoClass} ${watchedClass}`;

        li.innerHTML = `
          <div class="meta">
            <div class="name">${escapeHtml(item.title)}</div>
            <div class="sub">
              <span class="tag">${escapeHtml(item.type)}</span>
              <span class="tag">${escapeHtml(item.service || "Other")}</span>
              <span class="tag">${item.who === "me" ? "You" : "Anika"}</span>
              <span class="tag">${formatDate(item.createdAt)}</span>
              ${item.watched ? `<span class="tag">‚úÖ watched</span>` : ``}
            </div>
            ${item.notes ? `<div class="notes">${escapeHtml(item.notes)}</div>` : ``}
          </div>
          <div class="right">
            <button class="small" data-action="watched" data-id="${escapeHtml(item.id)}" ${!currentUser ? "disabled" : ""}>
              ${item.watched ? "Unwatch" : "Watched"}
            </button>
            <button class="small" data-action="delete" data-id="${escapeHtml(item.id)}" ${!currentUser ? "disabled" : ""}>Delete</button>
          </div>
        `;

        listEl.appendChild(li);
      }

      // random button should work once we have data
      randomBtn.disabled = (currentItems.filter(x => !x.watched).length === 0);
    }

    /**********************
     * Firestore paths
     * We store items in: watchlistRooms/{ROOM_ID}/items/{autoId}
     **********************/
    function itemsCollectionRef(){
      return collection(db, "watchlistRooms", ROOM_ID, "items");
    }

    function startRealtime(){
      if(unsubscribe) unsubscribe();

      const qy = query(itemsCollectionRef(), orderBy("createdAt", "desc"));

      unsubscribe = onSnapshot(qy, (snap) => {
        currentItems = snap.docs.map(d => {
          const v = d.data();
          const createdAtMs = v.createdAt?.toDate ? v.createdAt.toDate().getTime() : Date.now();
          return {
            id: d.id,
            title: v.title,
            type: v.type,
            service: v.service || "Other",
            who: v.who,
            notes: v.notes || "",
            watched: !!v.watched,
            createdAt: createdAtMs
          };
        });

        setStatus(`Sync: ON ‚Ä¢ live ‚Ä¢ room "${ROOM_ID}"`);
        render();
      }, (err) => {
        console.error(err);
        setStatus("Sync error (check Firestore rules)");
      });
    }

    /**********************
     * Actions
     **********************/
    async function addItem(){
      const title = titleEl.value.trim();
      if(!title) return;

      const payload = {
        title,
        type: typeEl.value,
        service: serviceEl.value,
        who: whoEl.value,
        notes: notesEl.value.trim(),
        watched: false,
        createdAt: serverTimestamp(),
        // optional: helpful for debugging/auditing
        addedByUid: currentUser?.uid || null,
        addedByEmail: currentUser?.email || null
      };

      try{
        await addDoc(itemsCollectionRef(), payload);
        titleEl.value = "";
        notesEl.value = "";
        titleEl.focus();
      }catch(err){
        console.error(err);
        setStatus("Add failed (check rules)");
      }
    }

    async function toggleWatched(id){
      const item = currentItems.find(x => x.id === id);
      if(!item) return;

      try{
        await updateDoc(doc(db, "watchlistRooms", ROOM_ID, "items", id), { watched: !item.watched });
      }catch(err){
        console.error(err);
        setStatus("Update failed (check rules)");
      }
    }

    async function deleteItem(id){
      try{
        await deleteDoc(doc(db, "watchlistRooms", ROOM_ID, "items", id));
      }catch(err){
        console.error(err);
        setStatus("Delete failed (check rules)");
      }
    }

    async function clearAll(){
      try{
        const snap = await getDocs(itemsCollectionRef());
        const batch = writeBatch(db);
        snap.forEach(d => batch.delete(d.ref));
        await batch.commit();
        randomResultEl.style.display = "none";
      }catch(err){
        console.error(err);
        setStatus("Clear failed (check rules)");
      }
    }

    function randomPick(){
      const picks = getFiltered(currentItems).filter(x => !x.watched);
      if(picks.length === 0){
        showRandomResult("No unwatched items match your filters üëÄ");
        return;
      }
      const pick = picks[Math.floor(Math.random() * picks.length)];
      showRandomResult(`Tonight: ${pick.title} (${pick.type}) on ${pick.service || "Other"} ‚ú®`);
    }

    /**********************
     * Auth
     **********************/
    async function doLogin(){
      try{
        await signInWithPopup(auth, provider);
      }catch(err){
        console.error(err);
        setStatus("Sign-in blocked (popup?)");
      }
    }

    async function doLogout(){
      try{
        await signOut(auth);
      }catch(err){
        console.error(err);
        setStatus("Sign-out failed");
      }
    }

    loginBtn.addEventListener("click", doLogin);
    logoutBtn.addEventListener("click", doLogout);

    onAuthStateChanged(auth, (user) => {
      currentUser = user || null;

      if(currentUser){
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        setEnabled(true);
        setStatus("Signed in ‚Ä¢ syncing‚Ä¶");
        startRealtime();
      }else{
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        currentItems = [];
        render();
        setEnabled(false);
        setStatus("Sign in to sync + add items");
        if(unsubscribe){ unsubscribe(); unsubscribe = null; }
      }
    });

    /**********************
     * Events
     **********************/
    addBtn.addEventListener("click", addItem);

    titleEl.addEventListener("keydown", (e) => {
      if(e.key === "Enter") addItem();
    });

    clearBtn.addEventListener("click", async () => {
      const ok = confirm("Clear the entire watchlist?");
      if(!ok) return;
      await clearAll();
    });

    randomBtn.addEventListener("click", randomPick);

    listEl.addEventListener("click", async (e) => {
      const btn = e.target.closest("button");
      if(!btn) return;

      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");

      if(!currentUser) return;

      if(action === "watched"){
        await toggleWatched(id);
      }
      if(action === "delete"){
        const ok = confirm("Delete this item?");
        if(!ok) return;
        await deleteItem(id);
      }
    });

    [searchEl, filterTypeEl, filterServiceEl, filterWhoEl].forEach(el => {
      el.addEventListener("input", render);
      el.addEventListener("change", render);
    });

    // initial UI state
    setEnabled(false);
    setStatus("Loading‚Ä¶");
  </script>
</body>
</html>
