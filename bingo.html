<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2026 Goals Bingo ðŸ’ž</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Confetti (for â€œCompleted Togetherâ€) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --pink1:#ff8cd6;
      --purple1:#b084f7;
      --card-bg:rgba(255,255,255,0.92);
      --rounded:22px;

      /* Theme accents */
      --me1:#ff2a2a;   /* blood red */
      --me2:#0b0b0f;   /* near-black */
      --her1:#ff78c8;
      --her2:#b084f7;

      /* Couples theme (red + pink blend) */
      --couples1:#ff2a6d; /* hot pink-red */
      --couples2:#ff3b30; /* iOS red */
      --couples3:#ff8cd6; /* pink */
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont;
      background:
        linear-gradient(135deg, rgba(255,140,214,0.65), rgba(176,132,247,0.75)),
        url("peonies.jpg") center/cover fixed no-repeat;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      padding:24px 14px;
      color:#111;
    }

    .wrap{ width:100%; max-width:980px; }

    header{
      text-align:center;
      margin-bottom:12px;
      color:#fff;
      text-shadow:0 2px 6px rgba(0,0,0,0.40);
    }
    header h1{
      font-family:"SF Pro Display",system-ui;
      font-size:28px;
      margin:0 0 6px 0;
      font-weight:600;
      letter-spacing:0.2px;
    }
    header p{
      margin:0;
      font-size:14px;
      opacity:0.95;
    }

    /* Google login bar */
    .loginbar{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      margin:12px 0 12px;
      flex-wrap:wrap;
    }

    .btn{
      padding:10px 14px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-family:"SF Pro Display",system-ui;
      background:linear-gradient(90deg,var(--pink1),var(--purple1));
      color:#fff;
      box-shadow:0 10px 26px rgba(0,0,0,0.18);
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .btn.secondary{
      background:rgba(0,0,0,0.10);
      color:#222;
      box-shadow:none;
      border:1px solid rgba(0,0,0,0.10);
    }

    /* Optional: â€œtoughâ€ red button variant */
    .btn.me{
      background:linear-gradient(90deg, var(--me1), var(--me2));
    }

    /* Couples button variant */
    .btn.couples{
      background: linear-gradient(90deg, var(--couples2), var(--couples3));
    }

    /* per-board toolbar row */
    .board-toolbar{
      display:flex;
      justify-content:center;
      gap:10px;
      margin: 0 0 12px;
      flex-wrap:wrap;
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }

    #syncStatus{
      text-align:center;
      margin:0 0 14px 0;
      font-size:13px;
      color:#fff;
      opacity:0.95;
      text-shadow:0 2px 6px rgba(0,0,0,0.35);
      min-height:18px;
    }

    .boards{
      display:grid;
      grid-template-columns:1fr;
      gap:18px;
    }
    @media (min-width:860px){
      .boards{ grid-template-columns:1fr 1fr; }
    }

    .board{
      background:var(--card-bg);
      border-radius:var(--rounded);
      box-shadow:0 18px 45px rgba(0,0,0,0.18);
      padding:16px;
      position: relative;
      overflow: hidden;
    }

    .board h2{
      text-align:center;
      font-family:"SF Pro Display",system-ui;
      font-size:18px;
      margin:0 0 12px 0;
      font-weight:600;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      gap:8px;
    }

    .cell{
      aspect-ratio:1 / 1;
      background:rgba(255,255,255,0.92);
      border-radius:14px;
      padding:8px;
      font-size:12px;
      line-height:1.25;
      border:1px solid rgba(0,0,0,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      cursor:pointer;
      position:relative;
      transition:transform 0.15s ease, box-shadow 0.15s ease;
      user-select:none;
      -webkit-user-select:none;
      -webkit-tap-highlight-color:transparent;
      overflow:hidden;
    }

    .cell:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(0,0,0,0.15);
    }

    /* show "editing" state without forcing contenteditable always on */
    .board.is-editing .cell{
      cursor:text;
      user-select:text;
      -webkit-user-select:text;
    }

    .cell[contenteditable="true"]{
      cursor:text;
      user-select:text;
      -webkit-user-select:text;
    }

    .cell[contenteditable="true"]:focus{
      outline:none;
      box-shadow:0 0 0 2px rgba(255,140,214,0.55);
      transform:none;
    }

    .cell.done{
      background:
        repeating-linear-gradient(
          -45deg,
          rgba(255,140,214,0.22),
          rgba(255,140,214,0.22) 6px,
          rgba(176,132,247,0.22) 6px,
          rgba(176,132,247,0.22) 12px
        );
      text-decoration:line-through;
      opacity:0.72;
    }

    .actions{
      margin-top:12px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }

    /* -------------------- THEMED BOARDS -------------------- */

    /* YOUR BOARD: Flame theme */
    .board-me{
      background:
        radial-gradient(1200px 520px at 18% 12%, rgba(255,170,70,0.35), transparent 55%),
        radial-gradient(900px 520px at 82% 28%, rgba(255,40,0,0.28), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.96), rgba(248,248,252,0.92));
      border: 1px solid rgba(255,120,20,0.22);
    }
    .board-me::before{
      content:"";
      position:absolute;
      inset:-45px;
      background:
        radial-gradient(circle at 20% 78%, rgba(255,190,90,0.26), transparent 55%),
        radial-gradient(circle at 55% 86%, rgba(255,70,0,0.22), transparent 60%),
        radial-gradient(circle at 80% 70%, rgba(255,230,140,0.18), transparent 60%);
      filter: blur(16px);
      opacity:.95;
      z-index:0;
      pointer-events:none;
      animation: flamePulse 3.2s ease-in-out infinite;
    }
    @keyframes flamePulse{
      0%,100%{ transform: translateY(0) scale(1); opacity:.88; }
      50%{ transform: translateY(-10px) scale(1.02); opacity:1; }
    }
    .board-me > *{ position:relative; z-index:1; }
    .board-me h2{ color:#2a0c06; text-shadow:none; }

    .board-me .cell{
      border:1px solid rgba(255,120,20,0.22);
      box-shadow: 0 8px 18px rgba(0,0,0,0.10);
      background: linear-gradient(180deg, rgba(255,170,70,0.10), rgba(255,70,0,0.06));
    }
    .board-me .cell:hover{ box-shadow: 0 14px 26px rgba(0,0,0,0.14); }
    .board-me .cell.done{
      background:
        repeating-linear-gradient(
          -45deg,
          rgba(255, 120, 20, 0.22),
          rgba(255, 120, 20, 0.22) 6px,
          rgba(255, 40, 0, 0.18) 6px,
          rgba(255, 40, 0, 0.18) 12px
        );
      text-decoration: line-through;
      opacity: 0.82;
    }
    .board-me .cell[contenteditable="true"]:focus{
      box-shadow: 0 0 0 2px rgba(255, 90, 20, 0.55);
    }

    /* ANIKA BOARD: Pink flower theme */
    .board-her{
      background:
        radial-gradient(900px 520px at 18% 16%, rgba(255,160,210,0.26), transparent 55%),
        radial-gradient(820px 520px at 82% 28%, rgba(255,210,235,0.24), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,240,250,0.92));
      border: 1px solid rgba(255,140,214,0.26);
    }
    .board-her::before{
      content:"";
      position:absolute;
      inset:-40px;
      pointer-events:none;
      z-index:0;
      opacity:.95;
      background:
        radial-gradient(circle at 14% 30%, rgba(255,170,210,0.24) 0 18%, transparent 19%),
        radial-gradient(circle at 28% 65%, rgba(255,130,190,0.20) 0 16%, transparent 17%),
        radial-gradient(circle at 55% 25%, rgba(255,220,240,0.22) 0 20%, transparent 21%),
        radial-gradient(circle at 72% 62%, rgba(255,150,205,0.20) 0 17%, transparent 18%),
        radial-gradient(circle at 88% 35%, rgba(255,230,245,0.18) 0 16%, transparent 17%);
      filter: blur(10px);
    }
    .board-her > *{ position:relative; z-index:1; }

    .board-her .cell{
      border:1px solid rgba(255,150,205,0.22);
      background: linear-gradient(180deg, rgba(255,170,220,0.10), rgba(255,120,180,0.06));
      box-shadow: 0 8px 18px rgba(0,0,0,0.10);
    }
    .board-her .cell:hover{ box-shadow: 0 14px 26px rgba(0,0,0,0.14); }
    .board-her .cell.done{
      background:
        repeating-linear-gradient(
          -45deg,
          rgba(255, 140, 214, 0.22),
          rgba(255, 140, 214, 0.22) 6px,
          rgba(176, 132, 247, 0.18) 6px,
          rgba(176, 132, 247, 0.18) 12px
        );
      text-decoration: line-through;
      opacity: 0.82;
    }
    .board-her .cell[contenteditable="true"]:focus{
      box-shadow: 0 0 0 2px rgba(255, 140, 214, 0.55);
    }

    /* COUPLES BOARD: Red + Pink blend */
    .board-couples{
      background:
        radial-gradient(900px 520px at 18% 16%, rgba(255, 42, 109, 0.22), transparent 55%),
        radial-gradient(820px 520px at 82% 28%, rgba(255, 59, 48, 0.20), transparent 60%),
        radial-gradient(900px 520px at 60% 80%, rgba(255, 140, 214, 0.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,245,250,0.92));
      border: 1px solid rgba(255, 70, 120, 0.26);
    }
    .board-couples::before{
      content:"";
      position:absolute;
      inset:-40px;
      pointer-events:none;
      z-index:0;
      opacity:.95;
      background:
        radial-gradient(circle at 18% 28%, rgba(255, 59, 48, 0.20) 0 18%, transparent 19%),
        radial-gradient(circle at 34% 70%, rgba(255, 42, 109, 0.18) 0 16%, transparent 17%),
        radial-gradient(circle at 60% 26%, rgba(255, 140, 214, 0.18) 0 18%, transparent 19%),
        radial-gradient(circle at 78% 62%, rgba(255, 59, 48, 0.16) 0 16%, transparent 17%);
      filter: blur(10px);
    }
    .board-couples > *{ position:relative; z-index:1; }

    .board-couples h2{ color:#2a0c1a; }

    .board-couples .cell{
      border:1px solid rgba(255, 70, 120, 0.22);
      background: linear-gradient(180deg, rgba(255, 59, 48, 0.08), rgba(255, 140, 214, 0.06));
      box-shadow: 0 8px 18px rgba(0,0,0,0.10);
    }
    .board-couples .cell:hover{ box-shadow: 0 14px 26px rgba(0,0,0,0.14); }
    .board-couples .cell.done{
      background:
        repeating-linear-gradient(
          -45deg,
          rgba(255, 59, 48, 0.20),
          rgba(255, 59, 48, 0.20) 6px,
          rgba(255, 140, 214, 0.18) 6px,
          rgba(255, 140, 214, 0.18) 12px
        );
      text-decoration: line-through;
      opacity: 0.82;
    }
    .board-couples .cell[contenteditable="true"]:focus{
      box-shadow: 0 0 0 2px rgba(255, 70, 120, 0.50);
    }

    /* Win overlay */
    #bingoWinOverlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.55);
      z-index:9999;
      padding:16px;
    }
    #bingoWinCard{
      width:min(420px, 92vw);
      background:rgba(255,255,255,0.92);
      border-radius:22px;
      padding:18px 16px;
      text-align:center;
      box-shadow:0 18px 45px rgba(0,0,0,0.25);
      font-family:"SF Pro Display",system-ui;
    }
    #bingoWinTitle{ font-size:18px; font-weight:700; }
    #bingoWinText{ margin-top:6px; font-size:14px; opacity:0.85; line-height:1.35; }
  </style>
</head>

<body>
  <!-- â€œCompleted Togetherâ€ overlay -->
  <div id="bingoWinOverlay" aria-label="Completed Together overlay">
    <div id="bingoWinCard">
      <div id="bingoWinTitle">Completed Together ðŸ’ž</div>
      <div id="bingoWinText"></div>
      <button id="bingoWinClose" class="btn" style="margin-top:12px;">Okay ðŸ«¶</button>
    </div>
  </div>

  <div class="wrap">
    <header>
      <h1>Our 2026 Bingo ðŸ’—</h1>
      <p>Type goals. Tap a square to cross it out. Finish the year together.</p>
    </header>

    <!-- Google login bar -->
    <div class="loginbar">
      <button id="loginBtn" class="btn" type="button">Sign in with Google</button>
      <button id="logoutBtn" class="btn secondary" type="button" style="display:none;">Sign out</button>
    </div>
    <div id="syncStatus"></div>

    <section class="boards" id="boardsArea" style="display:none;">
      <!-- ME -->
      <div class="board board-me">
        <h2>Anzumâ€™s Board</h2>

        <div class="board-toolbar">
          <button class="btn me" type="button" data-action="edit" data-board="me">Edit</button>
          <button class="btn me" type="button" data-action="save" data-board="me" disabled>Save</button>
          <button class="btn me" type="button" data-action="randomize" data-board="me">Randomize</button>
        </div>

        <div class="grid" id="board-me" aria-label="Anzum 2026 goals bingo board"></div>
        <div class="actions">
          <button class="btn secondary" type="button" onclick="resetBoard('me')">Reset</button>
        </div>
      </div>

      <!-- HER -->
      <div class="board board-her">
        <h2>Anikaâ€™s Board</h2>

        <div class="board-toolbar">
          <button class="btn" type="button" data-action="edit" data-board="partner">Edit</button>
          <button class="btn" type="button" data-action="save" data-board="partner" disabled>Save</button>
          <button class="btn" type="button" data-action="randomize" data-board="partner">Randomize</button>
        </div>

        <div class="grid" id="board-partner" aria-label="Anika 2026 goals bingo board"></div>
        <div class="actions">
          <button class="btn secondary" type="button" onclick="resetBoard('partner')">Reset</button>
        </div>
      </div>

      <!-- COUPLES -->
      <div class="board board-couples">
        <h2>Couples Bingo</h2>

        <div class="board-toolbar">
          <button class="btn couples" type="button" data-action="edit" data-board="couples">Edit</button>
          <button class="btn couples" type="button" data-action="save" data-board="couples" disabled>Save</button>
          <button class="btn couples" type="button" data-action="randomize" data-board="couples">Randomize</button>
        </div>

        <div class="grid" id="board-couples" aria-label="Couples bingo board"></div>
        <div class="actions">
          <button class="btn secondary" type="button" onclick="resetBoard('couples')">Reset</button>
        </div>
      </div>
    </section>
  </div>

  <script>
    /**********************
     * Local + UI behavior
     **********************/
    const SIZE = 25;
    const DONECOUNT_KEY = "bingoDoneCount";  // index.html reads this for the badge

    // Fixed room id
    const ROOM_ID = "tanzum-2026-bingo";
    function roomScopeKey() { return `room:${ROOM_ID}`; }

    function shuffleInPlace(arr){
      for (let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // edit-mode state per board (3 boards)
    const editState = { me: false, partner: false, couples: false };

    // Simple: only disable randomize while editing that board
    function updateRandomizeButtons(){
      ["me","partner","couples"].forEach((boardKey) => {
        const btn = document.querySelector(`button[data-action="randomize"][data-board="${boardKey}"]`);
        if (!btn) return;
        btn.disabled = !!editState[boardKey];
      });
    }

    // SIMPLE RANDOMIZE (no lock rules)
    function randomizeBoard(boardKey){
      if (editState[boardKey]) return;

      const cells = getCells(boardKey);
      if (!cells.length) return;

      const payload = cells.map(c => ({
        text: (c.innerText || "").trim(),
        done: c.classList.contains("done")
      }));

      shuffleInPlace(payload);

      for (let i = 0; i < cells.length; i++){
        cells[i].innerText = payload[i]?.text ?? "";
        cells[i].classList.toggle("done", !!payload[i]?.done);
      }

      // persist + sync (no celebration on shuffle)
      saveBoard(boardKey, { celebrate: false });
    }

    // helpers to toggle edit mode + save from toolbar
    function setEditMode(boardKey, on){
      editState[boardKey] = !!on;

      const gridEl = document.getElementById(`board-${boardKey}`);
      const boardCard = gridEl ? gridEl.closest(".board") : null;
      boardCard?.classList.toggle("is-editing", !!on);

      const cells = getCells(boardKey);
      cells.forEach(cell => {
        cell.contentEditable = on ? "true" : "false";
        cell.spellcheck = false;
      });

      const editBtn = document.querySelector(`button[data-action="edit"][data-board="${boardKey}"]`);
      const saveBtn = document.querySelector(`button[data-action="save"][data-board="${boardKey}"]`);
      if (editBtn) editBtn.disabled = on;
      if (saveBtn) saveBtn.disabled = !on;

      updateRandomizeButtons();
    }

    function toolbarSave(boardKey){
      saveBoard(boardKey, { celebrate: false });
      setEditMode(boardKey, false);
    }

    // Toolbar click handling
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action][data-board]");
      if (!btn) return;

      const boardKey = btn.dataset.board;
      const action = btn.dataset.action;

      if (action === "edit") setEditMode(boardKey, true);
      if (action === "save") toolbarSave(boardKey);
      if (action === "randomize") randomizeBoard(boardKey);
    });

    // prevent Enter (line breaks) while editing
    document.addEventListener("keydown", (e) => {
      const cell = e.target.closest(".cell[contenteditable='true']");
      if (!cell) return;
      if (e.key === "Enter") e.preventDefault();
    });

    function lineSets() {
      const lines = [];
      for (let r = 0; r < 5; r++) lines.push([0,1,2,3,4].map(c => r*5 + c)); // rows
      for (let c = 0; c < 5; c++) lines.push([0,1,2,3,4].map(r => r*5 + c)); // cols
      lines.push([0,6,12,18,24]); // diag
      lines.push([4,8,12,16,20]); // diag
      return lines;
    }

    function getCells(boardKey) {
      return [...document.querySelectorAll(`#board-${boardKey} .cell`)];
    }

    function getStoredBoard(boardKey) {
      try {
        return JSON.parse(localStorage.getItem(`bingo-${boardKey}`) || "[]");
      } catch {
        return [];
      }
    }

    function setStoredBoard(boardKey, data) {
      localStorage.setItem(`bingo-${boardKey}`, JSON.stringify(data));
    }

    function countAllDone() {
      const all = [
        ...getCells("me"),
        ...getCells("partner"),
        ...getCells("couples")
      ];
      return all.filter(c => c.classList.contains("done")).length;
    }

    function updateBadgeCount() {
      const done = countAllDone();
      localStorage.setItem(DONECOUNT_KEY, String(done));
    }
    window.updateBadgeCount = updateBadgeCount;

    // Completed lines store
    const LINES_KEY = "bingoLinesV2";
    function getCompletedLineIds() {
      let store = {};
      try { store = JSON.parse(localStorage.getItem(LINES_KEY) || "{}"); } catch { store = {}; }
      const scope = roomScopeKey();
      const list = store[scope] || [];
      return new Set(list);
    }

    function setCompletedLineIds(set) {
      let store = {};
      try { store = JSON.parse(localStorage.getItem(LINES_KEY) || "{}"); } catch { store = {}; }
      const scope = roomScopeKey();
      store[scope] = [...set];
      localStorage.setItem(LINES_KEY, JSON.stringify(store));
    }

    function showWin(text) {
      const overlay = document.getElementById("bingoWinOverlay");
      const winText = document.getElementById("bingoWinText");
      const closeBtn = document.getElementById("bingoWinClose");

      if (winText) winText.textContent = text;
      if (overlay) overlay.style.display = "flex";

      if (window.confetti) {
        confetti({ particleCount: 160, spread: 70, origin: { y: 0.65 } });
      }

      if (closeBtn) {
        closeBtn.onclick = () => { overlay.style.display = "none"; };
      }
      overlay?.addEventListener("click", (e) => {
        if (e.target === overlay) overlay.style.display = "none";
      }, { once: true });
    }

    function checkAndCelebrate(boardKey, whoLabel) {
      const cells = getCells(boardKey);
      const done = cells.map(c => c.classList.contains("done"));
      const lines = lineSets();
      const completed = getCompletedLineIds();

      let newLineFound = false;

      for (let i = 0; i < lines.length; i++) {
        const complete = lines[i].every(idx => done[idx]);
        const id = `${roomScopeKey()}:${boardKey}:${i}`;
        if (complete && !completed.has(id)) {
          completed.add(id);
          newLineFound = true;
        }
      }

      if (newLineFound) {
        setCompletedLineIds(completed);
        showWin(`${whoLabel} completed a line!`);
      }
    }
    window.__bingoCelebrateForBoard = (boardKey, whoLabel) => {
      try { checkAndCelebrate(boardKey, whoLabel); } catch {}
    };

    function whoLabelFor(boardKey){
      if (boardKey === "me") return "Anzum";
      if (boardKey === "partner") return "Anika";
      if (boardKey === "couples") return "Couples";
      return "Someone";
    }

    function saveBoard(boardKey, opts = { celebrate: true, whoLabel: "" }) {
      const cells = getCells(boardKey);
      const data = cells.map(c => ({
        text: (c.innerText || "").trim(),
        done: c.classList.contains("done")
      }));
      setStoredBoard(boardKey, data);

      updateBadgeCount();

      if (opts.celebrate) {
        const who = opts.whoLabel || whoLabelFor(boardKey);
        checkAndCelebrate(boardKey, who);
      }

      // If sync is on, schedule a push
      if (window.__bingoSchedulePush) window.__bingoSchedulePush();
    }
    window.saveBoard = saveBoard;

    function initBoard(boardKey) {
      const grid = document.getElementById(`board-${boardKey}`);
      if (!grid) return;

      const saved = getStoredBoard(boardKey);
      grid.innerHTML = "";

      for (let i = 0; i < SIZE; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";

        // start locked (not editable) until user hits Edit
        cell.contentEditable = "false";
        cell.spellcheck = false;

        if (saved[i]) {
          cell.innerText = saved[i].text || "";
          cell.classList.toggle("done", !!saved[i].done);
        }

        // Toggle done only when NOT editing
        cell.addEventListener("click", () => {
          if (editState[boardKey]) return;
          if (document.activeElement === cell) return;

          cell.classList.toggle("done");
          saveBoard(boardKey, { celebrate: true });
        });

        // While editing, we do NOT auto-save; Save button does it
        cell.addEventListener("input", () => {
          if (!editState[boardKey]) return;
        });

        grid.appendChild(cell);
      }

      setEditMode(boardKey, false);
      updateRandomizeButtons();
    }

    function resetBoard(boardKey) {
      const label = whoLabelFor(boardKey) + "â€™s";
      if (!confirm(`Clear ${label} board?`)) return;

      localStorage.removeItem(`bingo-${boardKey}`);
      initBoard(boardKey);
      updateBadgeCount();

      if (window.__bingoSchedulePush) window.__bingoSchedulePush();
    }
    window.resetBoard = resetBoard;

    // Boot local boards (hidden until login)
    initBoard("me");
    initBoard("partner");
    initBoard("couples");
    updateBadgeCount();
    updateRandomizeButtons();

    // Close overlay with ESC
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const overlay = document.getElementById("bingoWinOverlay");
        if (overlay && overlay.style.display === "flex") overlay.style.display = "none";
      }
    });
  </script>

  <!-- Firebase + Google Login + Firestore realtime sync -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const statusEl = document.getElementById("syncStatus");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const boardsArea = document.getElementById("boardsArea");

    function setStatus(msg){ if (statusEl) statusEl.textContent = msg || ""; }

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCcbJqHpYRPFGgmgBh5grAhR5aDniDZRyg",
      authDomain: "tanzum-5c20b.firebaseapp.com",
      projectId: "tanzum-5c20b",
      storageBucket: "tanzum-5c20b.firebasestorage.app",
      messagingSenderId: "301887898670",
      appId: "1:301887898670:web:6b0d43c29148ea9b830bbf",
      measurementId: "G-FF64TZSZ2V"
    };

    // SAME room for both of you
    const ROOM_ID = "tanzum-2026-bingo";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let unsub = null;
    let applyingRemote = false;
    let saveTimer = null;

    function getCells(boardKey){
      return [...document.querySelectorAll(`#board-${boardKey} .cell`)];
    }

    function boardToData(boardKey){
      const cells = getCells(boardKey);
      return cells.map(c => ({
        text: (c.innerText || "").trim(),
        done: c.classList.contains("done")
      }));
    }

    function applyBoard(boardKey, data){
      const cells = getCells(boardKey);
      if (!cells.length || !Array.isArray(data)) return;

      applyingRemote = true;

      for (let i = 0; i < cells.length; i++){
        const cell = cells[i];
        const item = data[i] || { text:"", done:false };

        // Don't overwrite what someone is typing right now on this device
        if (document.activeElement === cell) continue;

        const nextText = (item.text || "");
        if ((cell.innerText || "").trim() !== nextText) cell.innerText = nextText;
        cell.classList.toggle("done", !!item.done);
      }

      // Update local storage copies so refresh still works offline
      try { localStorage.setItem(`bingo-${boardKey}`, JSON.stringify(data)); } catch {}

      applyingRemote = false;

      // Badge + celebration check
      if (window.updateBadgeCount) window.updateBadgeCount();
      if (window.__bingoCelebrateForBoard) {
        const who =
          boardKey === "me" ? "Anzum" :
          boardKey === "partner" ? "Anika" :
          "Couples";
        window.__bingoCelebrateForBoard(boardKey, who);
      }
    }

    async function pushNow(){
      const ref = doc(db, "couplesBingoRooms", ROOM_ID);
      const payload = {
        me: boardToData("me"),
        partner: boardToData("partner"),
        couples: boardToData("couples"),
        updatedAt: serverTimestamp()
      };
      await setDoc(ref, payload, { merge: true });

      try {
        localStorage.setItem("bingoDoneCount", String(
          [...document.querySelectorAll(".cell.done")].length
        ));
      } catch {}
    }

    function schedulePush(){
      if (applyingRemote) return;

      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        pushNow().catch(()=>{});
      }, 450);
    }

    window.__bingoSchedulePush = schedulePush;

    function startListening(){
      if (unsub) unsub();
      const ref = doc(db, "couplesBingoRooms", ROOM_ID);
      unsub = onSnapshot(ref, (snap) => {
        const data = snap.data();
        if (!data) return;

        if (data.me) applyBoard("me", data.me);
        if (data.partner) applyBoard("partner", data.partner);
        if (data.couples) applyBoard("couples", data.couples);

        setStatus("Synced âœ… (live)");
      }, () => {
        setStatus("Sync error (check Firestore rules).");
      });
    }

    loginBtn?.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        console.log("Firebase login error:", e);
        setStatus(e?.code ? `Login error: ${e.code}` : "Login cancelled or blocked.");
      }
    });

    logoutBtn?.addEventListener("click", async () => {
      try {
        if (unsub) unsub();
        unsub = null;
        await signOut(auth);
      } catch {}
    });

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        boardsArea.style.display = "none";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        setStatus("Sign in to sync your boards.");
        return;
      }

      boardsArea.style.display = "grid";
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      setStatus("Connectingâ€¦");

      startListening();

      setTimeout(() => schedulePush(), 800);
    });
  </script>
</body>
</html>
